# FSMÃ—LLMæ§‹é€ ä»•æ§˜æ›¸ï¼ˆSamizoã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æº–æ‹ ï¼‰

ã“ã®æ–‡æ›¸ã¯ã€AITL-HXãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹ã€Œæœ¬èƒ½ã¨ã—ã¦ã®FSMã€ã¨ã€Œç†æ€§ã¨ã—ã¦ã®LLMã€ã‚’åˆ†é›¢çµ±åˆã™ã‚‹**Samizoã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã«åŸºã¥ã„ãŸåˆ¶å¾¡æ§‹é€ ä»•æ§˜ã‚’è¨˜è¿°ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

---

## ðŸ§­ ç›®çš„

- **å½¢å¼çš„åˆ¶å¾¡ï¼ˆFSMï¼‰**ã«ã‚ˆã‚‹å®‰å®šãƒ»å³å¿œæ€§
- **è¨€èªžãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰**ã«ã‚ˆã‚‹çŠ¶æ³ç†è§£ã¨ä¾‹å¤–å‡¦ç†
- ä¸¡è€…ã‚’**ç–Žçµåˆ**ã§çµ±åˆã—ã€å‹•çš„ç’°å¢ƒã«å¯¾å¿œã™ã‚‹é©å¿œåˆ¶å¾¡ã‚’å®Ÿç¾ã™ã‚‹

---

## ðŸ§  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹é€ 

```
[LLM Interface] â”€â”€â”€â”€â”
                    â–¼
         +-------------------------+
         |     FSM Engine          |  â† æœ¬èƒ½çš„çŠ¶æ…‹é·ç§»ï¼ˆé«˜é€Ÿãƒ»å½¢å¼çš„ï¼‰
         |   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      |
         |   çŠ¶æ…‹: sensing, act... |
         +-------------------------+
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                        â–¼
[Hâˆž Controller]         [Fallback Command (e.g. stop)]
        â–¼
[Actuator Command Output]
```

---

## ðŸ§© ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©

### 1. FSM Engineï¼ˆfsm_engine.pyï¼‰

- `fsm_state_def.yaml` ã«å®šç¾©ã•ã‚ŒãŸçŠ¶æ…‹é·ç§»è¡¨ã‚’å‚ç…§
- ã‚»ãƒ³ã‚µå…¥åŠ›ã‚„LLMã‹ã‚‰ã®ãƒ•ãƒ©ã‚°ã‚’å…ƒã«ã€ç¾åœ¨ã®çŠ¶æ…‹ã¨æ¬¡çŠ¶æ…‹ã‚’æ±ºå®š
- è»¢é€ã•ã‚Œã‚‹åˆ¶å¾¡å‘½ä»¤ã¯ **Hâˆž Controller** ã¸æ¸¡ã•ã‚Œã‚‹

### 2. LLM Interfaceï¼ˆllm_interface.pyï¼‰

- å¯¾è©±å±¥æ­´ã€ã‚»ãƒ³ã‚µç•°å¸¸ã€å¤–éƒ¨ã‚³ãƒžãƒ³ãƒ‰ãªã©ã‚’è‡ªç„¶è¨€èªžå‡¦ç†ã§è§£é‡ˆ
- ã€Œæ„å›³ã€ã¾ãŸã¯ã€Œç•°å¸¸æŽ¨è«–ã€ã‚’FSMã«æ¸¡ã™ï¼ˆãƒ•ãƒ©ã‚°ã‚„è£œåŠ©æƒ…å ±ã¨ã—ã¦ï¼‰
- ä¾‹ï¼š
  ```json
  {
    "llm_intent": "safe_shutdown",
    "reason": "temperature exceeds 80Â°C"
  }
  ```

### 3. çŠ¶æ…‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆfsm_state_def.yamlï¼‰

```yaml
initial_state: idle
states:
  idle:
    on_entry: log_idle
    transitions:
      - trigger: start
        condition: always
        target: sensing
  sensing:
    on_entry: acquire_data
    transitions:
      - trigger: high_temp
        condition: temp > 80
        target: emergency_stop
      - trigger: nominal
        condition: temp <= 80
        target: control_loop
...
```

---

## âš™ï¸ FSMâ†”LLMé€£æºãƒ•ãƒ­ãƒ¼

1. ã‚»ãƒ³ã‚µç•°å¸¸ã‚’FSMãŒæ¤œçŸ¥ã§ããªã„å ´åˆã€LLMãŒæ„å‘³çš„ã«è§£é‡ˆï¼ˆä¾‹ï¼šã€ŒæŒ¯å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé€šå¸¸ã¨ç•°ãªã‚‹ã€ï¼‰
2. LLMãŒè£œåŠ©ãƒ•ãƒ©ã‚°ï¼ˆ`llm_override`, `intent`, `risk_flag`ï¼‰ã‚’FSMã«é€ä¿¡
3. FSMã¯é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–° or å®‰å…¨çŠ¶æ…‹ã¸ç§»è¡Œ
4. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯å†ã³LLMã¸è¿”å´ï¼ˆè‡ªå·±å­¦ç¿’æ”¯æ´ï¼‰

---

## ðŸ›¡ï¸ å®‰å…¨è¨­è¨ˆã¨åˆ†é›¢æ€§

- FSMã®çŠ¶æ…‹é·ç§»ã¯å¸¸ã« **æ±ºå®šè«–çš„** ã‹ã¤ **å½¢å¼çš„æ¤œè¨¼**ãŒå¯èƒ½ãªæ§‹é€ ã¨ã™ã‚‹
- LLMã¯**ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆçš„æŽ¨è«–æ”¯æ´**ã§ã‚ã‚Šã€æœ€çµ‚åˆ¶å¾¡ã¯FSMãŒåˆ¤æ–­
- éžå¸¸æ™‚ã¯å¸¸ã« FSM â†’ `emergency_stop` or `shutdown` ã«å³ç§»è¡Œ

---

## ðŸš€ ä»Šå¾Œã®æ‹¡å¼µ

- LLMã«ã‚ˆã‚‹çŠ¶æ…‹é·ç§»ãƒ†ãƒ¼ãƒ–ãƒ«ã®**è‡ªå‹•æ›´æ–°ææ¡ˆ**
- ãƒ­ã‚°è§£æžã«ã‚ˆã‚‹ã€ŒçŠ¶æ…‹é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ„å‘³çš„æ¤œè¨¼ã€
- FSMâ†’LLMâ†’FSMã¨ã„ã†**å¯¾è©±çš„åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—**ã®PoCå®Ÿè£…

---

## ðŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `fsm_engine.py`: å®Ÿè£…æœ¬ä½“
- `fsm_state_def.yaml`: çŠ¶æ…‹ã¨é·ç§»å®šç¾©
- `llm_interface.py`: LLMå´æŽ¨è«–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- `interaction_scenario.md`: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ä¾‹ã¨PoCã®æƒ³å®šçŠ¶æ³

---

## ðŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License  
(C) 2025 Shinichi Samizo & AITL Project Team
